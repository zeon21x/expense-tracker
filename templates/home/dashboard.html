{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Dashboard</title>

    <!-- Bootstrap & DataTables CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    

    <style>
        body { font-family: 'Segoe UI', sans-serif; }
        #layoutSidenav { display: flex; min-height: 100vh; }
        #layoutSidenav_nav { width: 250px; background: #343a40; color: #fff; flex-shrink: 0; }
        #layoutSidenav_nav a { color: #fff; text-decoration: none; padding: 10px 20px; display: block; }
        #layoutSidenav_nav a:hover { background: #495057; }
        #layoutSidenav_content {
    flex: 1;
    padding: 25px;
    background: linear-gradient(135deg, #1e3c72, #2a5298);
}
        .sb-sidenav-menu-heading { padding: 15px 20px; font-size: 0.85rem; text-transform: uppercase; color: #adb5bd; }
        .sb-sidenav-footer { position: absolute; bottom: 0; width: 100%; padding: 10px; font-size: 0.9rem; }

        /* Dashboard Cards */
       .dashboard-card {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    color: white;
    text-align: center;
    transition: 0.3s ease;
}

.dashboard-card:hover {
    transform: translateY(-5px);
}

.dashboard-card h5 {
    font-size: 16px;
    opacity: 0.8;
}

.dashboard-card p {
    font-size: 28px;
    font-weight: bold;
}

        /* Chart Containers */
     

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #layoutSidenav { flex-direction: column; }
            #layoutSidenav_nav { width: 100%; min-height: auto; position: relative; }
            #layoutSidenav_content { padding: 15px; }
        }
    </style>
</head>
<body>
<div id="layoutSidenav">
    <!-- Sidebar -->
    <div id="layoutSidenav_nav">
        <nav class="sb-sidenav">
            <div class="sb-sidenav-menu">
                <div class="nav flex-column">
                    <div class="sb-sidenav-menu-heading">Core</div>
                    <a class="nav-link" href="/index"><i class="fas fa-tachometer-alt"></i> Dashboard</a>

                    <div class="sb-sidenav-menu-heading">Interface</div>
                    <a class="nav-link" href="/profile"><i class="fas fa-user"></i> Profile</a>
                    <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseRecords">
                            <div class="sb-nav-link-icon"><i class="fas fa-book-open"></i></div>
                            Records
                            <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                        </a>
                        <div class="collapse" id="collapseRecords" data-parent="#sidenavAccordion">
                            <nav class="sb-sidenav-menu-nested nav">
                                <a class="nav-link" href="{% url 'weekly' %}">Weekly Record</a>
                                <a class="nav-link" href="{% url 'stats' %}">Monthly Record</a>
                            </nav>
                        </div>

                    <div class="sb-sidenav-menu-heading">Addons</div>
                    <a class="nav-link" href="/info">
                        <div class="sb-nav-link-icon"><i class="fas fa-table"></i></div>
                        Yearly Record
                    </a>
                    <a class="nav-link" href="/tables"><i class="fas fa-table"></i> History</a>
                </div>
            </div>
            <div class="sb-sidenav-footer">
                        <div class="small">Logged in as:</div>
                        {{request.user.username}}
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div id="layoutSidenav_content">
        <main>
            <div class="container-fluid">
                <h1 class="mt-4 mb-4">Expense Dashboard</h1>

                <!-- Summary Cards -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <h5>Total Expense</h5>
                            <p>{{ total_expense }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <h5>Total Income</h5>
                            <p>{{ total_income }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <h5>Current Balance</h5>
                            <p>{{ current_income }}</p>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="row">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h5 class="mb-3">Weekly Expenses by Category</h5>
                            <canvas id="weeklyChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h5 class="mb-3">Monthly Expenses by Category</h5>
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="chart-container">
                            <h5 class="mb-3">Yearly Expenses by Category</h5>
                            <canvas id="yearlyChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Full Transaction Table -->
                <div class="chart-container mt-4">
                    <h5 class="mb-3">Full Transactions</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered" id="transactionsTable">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Category</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for info in page_obj %}
                                <tr>
                                    <td>{{ info.add_money }}</td>
                                    <td>{{ info.quantity }}</td>
                                    <td>{{ info.Category }}</td>
                                    <td>{{ info.Date }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>

<script>
    // Initialize DataTable
    $('#transactionsTable').DataTable();

    // Function to generate random colors
    function getRandomColors(count) {
        let colors = [];
        for (let i = 0; i < count; i++) {
            const r = Math.floor(Math.random() * 255);
            const g = Math.floor(Math.random() * 255);
            const b = Math.floor(Math.random() * 255);
            colors.push(`rgba(${r}, ${g}, ${b}, 0.6)`);
        }
        return colors;
    }

    // ✅ FIXED: Function to create upward-growing charts
    function createChart(ctxId, data, label) {
        const ctx = document.getElementById(ctxId).getContext('2d');
        const labels = Object.keys(data);
        const values = Object.values(data).map(v => Math.abs(v)); // ✅ Make all positive
        const colors = getRandomColors(labels.length);

        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: values,
                    backgroundColor: colors,
                    borderColor: colors.map(c => c.replace('0.6', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value;
                            }
                        }
                    }
                }
            }
        });
    }

    // Load data from Django context
    const weeklyData = {{ weekly_expense_json|safe }};
    const monthlyData = {{ monthly_expense_json|safe }};
    const yearlyData = {{ yearly_expense_json|safe }};

    // Create charts
    createChart('weeklyChart', weeklyData, 'Weekly Expenses');
    createChart('monthlyChart', monthlyData, 'Monthly Expenses');
    createChart('yearlyChart', yearlyData, 'Yearly Expenses');
</script>
</body>
</html>
